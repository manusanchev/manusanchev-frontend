name: manusanchev-CI-CD

on:
  push:
    branches: [ master ]

jobs:
  build_and_push:
    name: Build and push image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repo
        uses: actions/checkout@v2

      - name: Build container image
        run: docker build -t manusanchev/portfolio:$(echo $GITHUB_SHA | head -c7) .

      - name: Login to Docker Hub
        run:  docker login -u ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} -p ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Push container image to docker hub
        run: docker push manusanchev/portfolio:$(echo $GITHUB_SHA | head -c7)



  deploy:
    name:
    - name: execute ssh
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSHKEY }}
        port: ${{ secrets.PORT }}
        script: |
          # Login to registry
          docker login -u ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} -p ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          # Stop running container
          docker stop $(echo $IMAGE_NAME)
          # Remove old container
          docker rm $(echo $IMAGE_NAME)
          # Run a new container from a new image
          docker run -d \
          --restart always \
          --name $(echo $IMAGE_NAME) \
          $(echo $REGISTRY)/$(echo $IMAGE_NAME):$(echo $GITHUB_SHA | head -c7)